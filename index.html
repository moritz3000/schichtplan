<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
  import { 
    getFirestore, 
    collection, 
    getDocs, 
    addDoc, 
    updateDoc, 
    deleteDoc, 
    doc, 
    onSnapshot, 
    query, 
    where, 
    arrayUnion, 
    arrayRemove 
  } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyADch6nVtF-ljkPWvsae-rHEaiuKJSswY0",
    authDomain: "schichtplan-5c70f.firebaseapp.com",
    projectId: "schichtplan-5c70f",
    storageBucket: "schichtplan-5c70f.appspot.com",
    messagingSenderId: "502149312331",
    appId: "1:502149312331:web:1dbce2d7fa034f25d702ce",
    measurementId: "G-0DL0R5B7LV"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  
  // JavaScript Code zur Integration von Firestore
  let loggedInUser = null;
  let canRemove = false;

  // Setze das aktuelle Datum im Header
  function setCurrentDate() {
      const currentDateElement = document.getElementById('currentDate');
      const today = new Date();
      const options = { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'long' };
      currentDateElement.textContent = today.toLocaleDateString('de-DE', options);
  }

  // Funktion zum Rendern aller Events im Container und in der Tabelle
  function updateDisplay() {
      // Firestore ist durch onSnapshot bereits für Echtzeit-Updates eingerichtet
      // Diese Funktion muss daher nicht mehr etwas tun
  }

  // Rendern der Event-Container
  function renderEventContainer(savedData) {
      const eventContainer = document.getElementById('eventContainer');
      eventContainer.innerHTML = ''; // Container leeren

      savedData.forEach((event) => {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.innerHTML = `
              <p>${formatDate(event.datum)}</p>
              <h3>Event: ${event.name}</h3>
              <button onclick="confirmForEvent('${event.id}')">Bestätigen</button>
              ${canRemove ? `<button class="remove-event" onclick="removeEvent('${event.id}')" title="Event löschen">x</button>` : ''}
          `;
          eventContainer.appendChild(eventDiv);
      });
  }

  // Rendern der Verfügbarkeits-Tabelle
  function renderAvailabilityTable(savedData) {
      const tableBody = document.getElementById('availabilityTable');
      tableBody.innerHTML = ''; // Tabelle leeren

      savedData.forEach((event) => {
          const row = document.createElement('tr');

          // Datum
          const datumCell = document.createElement('td');
          datumCell.textContent = formatDate(event.datum);
          row.appendChild(datumCell);

          // Name
          const nameCell = document.createElement('td');
          nameCell.textContent = event.name;
          row.appendChild(nameCell);

          // Verfügbare Mitarbeiter
          const mitarbeiterCell = document.createElement('td');
          event.mitarbeiter.forEach((name) => {
              const nameSpan = document.createElement('span');
              nameSpan.className = 'name-item';
              nameSpan.textContent = name;

              if (canRemove) {
                  const removeBtn = document.createElement('button');
                  removeBtn.className = 'remove';
                  removeBtn.textContent = 'x';
                  removeBtn.title = 'Name entfernen';
                  removeBtn.onclick = () => removeName(event.id, name);
                  nameSpan.appendChild(removeBtn);
              }

              mitarbeiterCell.appendChild(nameSpan);
          });
          row.appendChild(mitarbeiterCell);

          tableBody.appendChild(row);
      });
  }

  // Initial Load: Fetch all events und setze einen Echtzeit-Listener
  function initializeAppData() {
      const eventsCollection = collection(db, "events");
      onSnapshot(eventsCollection, (snapshot) => {
          const savedData = [];
          snapshot.forEach((doc) => {
              savedData.push({ id: doc.id, ...doc.data() });
          });
          renderEventContainer(savedData);
          renderAvailabilityTable(savedData);
      }, (error) => {
          console.error("Fehler beim Abrufen der Events: ", error);
      });
  }

  // Anmelden mit PIN
  async function login() {
      const pin = document.getElementById('passwordInput').value;
      const selectedEmployee = document.getElementById('employeeSelect').value;

      if (!selectedEmployee) {
          alert('Bitte wähle einen Mitarbeiter aus.');
          return;
      }

      if (selectedEmployee === 'Fabi' && pin === '123') {
          loggedInUser = selectedEmployee;
          canRemove = true;
          alert('Fabi ist eingeloggt. Lösch- und Erstellungsfunktionen aktiviert.');
          document.getElementById('eventForm').style.display = 'block';
      } else if (pin === '1234') {
          loggedInUser = selectedEmployee;
          canRemove = false;
          alert(`${selectedEmployee} ist eingeloggt.`);
          document.getElementById('eventForm').style.display = 'none';
      } else {
          alert('Falscher PIN.');
          return;
      }

      // Aktualisiere den Header mit dem eingeloggten Benutzer
      const welcomeUserElement = document.getElementById('welcomeUser');
      welcomeUserElement.textContent = `Willkommen ${loggedInUser}!`;
      welcomeUserElement.style.display = 'block';

      document.getElementById('passwordField').style.display = 'none';
      // No need to updateDisplay, onSnapshot handles it
  }

  function handleLoginChange() {
      loggedInUser = null;
      canRemove = false;
      document.getElementById('passwordField').style.display = 'block';
      document.getElementById('eventForm').style.display = 'none';

      // Entferne die Begrüßung aus dem Header
      const welcomeUserElement = document.getElementById('welcomeUser');
      welcomeUserElement.textContent = 'Willkommen!';
      welcomeUserElement.style.display = 'none';
  }

  // Bestätigen eines Events für den Benutzer
  async function confirmForEvent(eventId) {
      if (!loggedInUser) {
          alert('Bitte logge dich zuerst ein.');
          return;
      }

      const eventDocRef = doc(db, "events", eventId);
      try {
          await updateDoc(eventDocRef, {
              mitarbeiter: arrayUnion(loggedInUser)
          });
      } catch (error) {
          console.error("Fehler beim Bestätigen des Events: ", error);
          alert('Es gab ein Problem beim Bestätigen des Events.');
      }
  }

  // Entfernen eines Namens aus einem Event
  async function removeName(eventId, name) {
      if (canRemove) {
          const eventDocRef = doc(db, "events", eventId);
          try {
              await updateDoc(eventDocRef, {
                  mitarbeiter: arrayRemove(name)
              });
          } catch (error) {
              console.error("Fehler beim Entfernen des Namens: ", error);
              alert('Es gab ein Problem beim Entfernen des Namens.');
          }
      }
  }

  // Hinzufügen eines neuen Events
  async function addEvent() {
      if (!canRemove) {
          alert('Nur Fabi kann Events erstellen.');
          return;
      }

      let eventName = document.getElementById('eventName').value.trim();
      const isOther = eventName === 'sonstige';
      if (isOther) {
          const otherEvent = document.getElementById('otherEvent').value.trim();
          if (!otherEvent) {
              alert('Bitte gib den Namen des sonstigen Events ein.');
              return;
          }
          eventName = otherEvent;
      }

      const eventDate = document.getElementById('eventDate').value;
      const eventTime = document.getElementById('eventTime').value;

      if (!eventName || !eventDate || !eventTime) {
          alert('Bitte alle Felder ausfüllen.');
          return;
      }

      try {
          // Überprüfen, ob das Event bereits existiert
          const q = query(collection(db, "events"),
              where("datum", "==", eventDate),
              where("name", "==", eventName),
              where("startzeit", "==", eventTime)
          );
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
              alert('Dieses Event existiert bereits.');
              return;
          }

          // Neues Event hinzufügen
          await addDoc(collection(db, "events"), {
              datum: eventDate,
              name: eventName,
              startzeit: eventTime,
              mitarbeiter: []
          });

          alert('Event hinzugefügt.');
          // Reset Form
          document.getElementById('eventForm').reset();
          document.getElementById('otherEventContainer').style.display = 'none';
          // No need to updateDisplay, onSnapshot handles it
      } catch (error) {
          console.error('Fehler beim Hinzufügen des Events: ', error);
          alert('Es gab ein Problem beim Hinzufügen des Events.');
      }
  }

  // Entfernen eines Events
  async function removeEvent(eventId) {
      if (!canRemove) {
          alert('Nur Fabi kann Veranstaltungen löschen.');
          return;
      }

      if (confirm('Bist du sicher, dass du dieses Event löschen möchtest?')) {
          const eventDocRef = doc(db, "events", eventId);
          try {
              await deleteDoc(eventDocRef);
              alert('Event gelöscht.');
          } catch (error) {
              console.error('Fehler beim Löschen des Events: ', error);
              alert('Es gab ein Problem beim Löschen des Events.');
          }
      }
  }

  function toggleOtherEvent() {
      const eventName = document.getElementById('eventName').value;
      const otherEventContainer = document.getElementById('otherEventContainer');
      if (eventName === 'sonstige') {
          otherEventContainer.style.display = 'block';
      } else {
          otherEventContainer.style.display = 'none';
      }
  }

  function formatDate(dateStr) {
      const options = { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'long' };
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', options);
  }

  function formatTime(timeStr) {
      const [hours, minutes] = timeStr.split(':');
      return `${hours}:${minutes}`;
  }

  // Collapsible functionality (falls benötigt)
  const collapsibles = document.querySelectorAll('.collapsible');
  collapsibles.forEach(collapsible => {
      collapsible.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          if (content.style.display === 'block') {
              content.style.display = 'none';
          } else {
              content.style.display = 'block';
          }
      });
  });

  // Öffne den collapsible Bereich automatisch, wenn Fabi eingeloggt ist
  function openCollapsible() {
      const collapsible = document.querySelector('.collapsible');
      if (collapsible && !collapsible.classList.contains('active')) {
          collapsible.click();
      }
  }

  // Initialisierung nach DOM geladen
  document.addEventListener('DOMContentLoaded', () => {
      setCurrentDate();
      initializeAppData();
  });

  // Expose functions to the global scope for inline event handlers
  window.login = login;
  window.handleLoginChange = handleLoginChange;
  window.confirmForEvent = confirmForEvent;
  window.removeName = removeName;
  window.addEvent = addEvent;
  window.removeEvent = removeEvent;
  window.toggleOtherEvent = toggleOtherEvent;
</script>
    
    <style>
        /* Ihr bestehendes CSS bleibt unverändert */
        /* ... Ihr CSS-Code ... */
    </style>
</head>
<body>
    <header>
        <div class="title">G Schichtplanung</div>
        <div id="welcomeUser" style="display: none;">Willkommen!</div>
    </header>
    <div class="container">
        <p id="currentDate" style="font-size: 1.1em; margin-bottom: 20px;"></p>
        <div>
            <label for="employeeSelect">Mitarbeiter auswählen:</label>
            <select id="employeeSelect" onchange="handleLoginChange()">
                <option value="">-- Wähle einen Namen --</option>
                <option value="Moritz">Moritz</option>
                <option value="Arnesa">Arnesa</option>
                <option value="Fabi">Fabi</option>
                <option value="Melissa">Melissa</option>
                <option value="Gidde">Gidde</option>
                <option value="Amer">Amer</option>
                <option value="Gregor">Gregor</option>
                <option value="Zeki">Zeki</option>
            </select>
            <div id="passwordField" style="display: none;">
                <label for="passwordInput">PIN:</label>
                <!-- Verwendung von input type="password" für verborgene Eingabe und numerische Eingabe -->
                <input type="password" id="passwordInput" pattern="\d*" inputmode="numeric" placeholder="PIN eingeben" maxlength="6">
                <button onclick="login()">Einloggen</button>
            </div>
            <hr>
        </div>

        <div class="content" id="eventForm">
            <h3>Neues Event hinzufügen</h3>
            <label for="eventName">Event Name:</label>
            <select id="eventName" onchange="toggleOtherEvent()">
                <option value="">-- Wähle ein Event --</option>
                <option value="Bunkernacht">Bunkernacht</option>
                <option value="Pferdreht">Pferdreht</option>
                <option value="IDOLS">IDOLS</option>
                <option value="Baracke">Baracke</option>
                <option value="Crypt">Crypt</option>
                <option value="Dancehall Station">Dancehall Station</option>
                <option value="LOL">LOL</option>
                <option value="sonstige">Sonstige</option>
            </select>

            <div id="otherEventContainer">
                <label for="otherEvent">Sonstiges Event:</label>
                <input type="text" id="otherEvent" placeholder="Event Name eingeben">
            </div>

            <!-- Datum und Startzeit in einer Zeile -->
            <div class="date-time" style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="eventDate">Datum:</label>
                    <input type="date" id="eventDate">
                </div>
                <div style="flex: 1;">
                    <label for="eventTime">Startzeit:</label>
                    <input type="time" id="eventTime">
                </div>
            </div>

            <button onclick="addEvent()">Event hinzufügen</button>
            <hr>
        </div>

        <!-- Container für Events -->
        <div id="eventContainer">
            <!-- Dynamisch hinzugefügte Events erscheinen hier als Container -->
        </div>

        <table>
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Name</th>
                    <th>Verfügbare Mitarbeiter</th>
                </tr>
            </thead>
            <tbody id="availabilityTable">
                <!-- Dynamisch hinzugefügte Events erscheinen hier -->
            </tbody>
        </table>
    </div>
</body>
</html>
